/**
 * This ruleset enforces a security model for a pilgrim registration system.
 *
 * Core Philosophy:
 * The security model is designed to be simple and secure. It allows public, read-only access to foundational data (like Ghat locations) while enabling any authenticated user (including those signed in anonymously) to create their own registration. Crucially, once a registration is created, it cannot be read, updated, or deleted from the client-side to protect user privacy and data integrity.
 *
 * Data Structure:
 * The data is organized into two distinct, top-level collections:
 * 1. /ghats/{ghatId}: Stores public information about Ghat locations, schedules, and capacity.
 * 2. /pilgrim_registrations/{registrationId}: Stores private registration details for each pilgrim or group.
 *
 * Key Security Decisions:
 * - Public Read-Only Data: The `/ghats` collection is publicly readable by anyone but cannot be modified by clients. This ensures the integrity of core application data.
 * - Anonymous Write Access: In line with the application's use of anonymous authentication, any user with a valid auth token can create a document in `/pilgrim_registrations`.
 * - No Reads on Private Data: To prevent any possibility of data leakage where one user could see another's registration details (full name, mobile number), all client-side read (`get`, `list`) and modification (`update`, `delete`) operations on `/pilgrim_registrations` are disabled. The application should rely on the client-side state after a successful creation or use a trusted server environment (like Cloud Functions) for any data retrieval needs.
 * - Authentication Providers: The application logic uses Phone and Anonymous authentication. For the system to function correctly, both the "Anonymous" and "Phone" sign-in providers must be enabled in the Firebase Authentication settings in the Firebase Console. The 'auth/operation-not-allowed' error indicates one of these is disabled.
 *
 * Denormalization for Authorization:
 * This ruleset intentionally avoids `get()` or `exists()` calls for performance and security. The current model is simple, but if future requirements involve users managing their own registrations, the `PilgrimRegistration` entity MUST be updated to include an `ownerId` field (e.g., `ownerId: request.auth.uid`). This denormalized field would allow for secure rules like `allow read, update, delete: if isOwner(resource.data.ownerId);`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable, maintainable rules.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description
     *   Rules for the 'ghats' collection, which contains public information
     *   about each Ghat location, its time slots, and capacity.
     * @path
     *   /ghats/{ghatId}
     * @allow
     *   (get) Any user, signed in or not, can read the details of a Ghat.
     * @deny
     *   (create) No user can create, update, or delete a Ghat from the client.
     * @principle
     *   Protects core application data by making it read-only for all clients.
     */
    match /ghats/{ghatId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     *   Rules for the 'pilgrim_registrations' collection. Allows any authenticated user
     *   to create a registration but denies all subsequent reads and modifications to
     *   ensure the privacy of all users' registration data.
     * @path
     *   /pilgrim_registrations/{registrationId}
     * @allow
     *   (create) An anonymously signed-in user can submit a new registration.
     * @deny
     *   (get) A user cannot read their own or anyone else's registration details.
     * @deny
     *   (list) A user cannot list all registrations, preventing a major data leak.
     * @deny
     *   (update) No user can modify a registration after it has been created.
     * @principle
     *   Enforces a write-once policy for authenticated users. Disables reads to protect
     *   sensitive user information like names and mobile numbers, which is critical
     *   in a schema that does not have a per-document ownership field.
     */
    match /pilgrim_registrations/{registrationId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}